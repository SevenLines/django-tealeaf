// Generated by CoffeeScript 1.7.1
(function() {
  var GroupNav, StudentsControl, StudentsTable, YearNav, cookie_discp_id, cookie_group_id, cookie_year;

  cookie_group_id = function() {
    return $.cookie('group_id');
  };

  cookie_discp_id = function() {
    return $.cookie('discipline_id');
  };

  cookie_year = function() {
    return $.cookie('year');
  };

  StudentsTable = (function() {
    function StudentsTable() {}

    StudentsTable.need_to_be_reloaded = null;

    StudentsTable.selector_table = "#group-students .content";

    StudentsTable.selector_form_add = "" + StudentsTable.selector_table + " form.add";

    StudentsTable.selector_form_remove = "" + StudentsTable.selector_table + " form.remove";

    StudentsTable.selector_form_update = "" + StudentsTable.selector_table + " form.update";

    StudentsTable.pstfx_old = "_old";

    StudentsTable.ACTIONS = {
      Update: 1,
      Add: 2,
      Remove: 3
    };

    StudentsTable.last_action = 0;

    StudentsTable.last_student_id = -1;

    StudentsTable.check_changed = function(form) {
      var i, name, siblings, _i, _len, _ref;
      _ref = $(form).find("input[type=text]");
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        i = _ref[_i];
        name = "" + i.name + StudentsTable.pstfx_old;
        siblings = $(i).siblings("input[name=" + name + "]");
        if (siblings.size() > 0) {
          if (i.value !== siblings[0].value) {
            return true;
          }
        }
      }
      return false;
    };

    StudentsTable.select_last_student_form_update = function() {
      var input_second_name, selector, student_id;
      selector = "input[name=student_id][value=" + StudentsTable.last_student_id + "]";
      console.log(selector);
      student_id = $(this.selector_form_update).find(selector);
      if (student_id.size()) {
        input_second_name = student_id.siblings("input[name=second_name]");
        if (input_second_name.size() > 0) {
          return input_second_name[0].focus();
        }
      }
    };

    StudentsTable.send_changed_students = function() {
      var f, request, requests, _i, _len, _ref;
      requests = [];
      _ref = $(StudentsTable.selector_form_update);
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        f = _ref[_i];
        if (StudentsTable.check_changed(f)) {
          request = $.post(f.action, $(f).serialize());
          console.log(request);
          requests.push(request);
        }
      }
      $.when(requests).then(function() {
        StudentsTable.last_action = StudentsTable.ACTIONS.Update;
        if (StudentsTable.need_to_be_reloaded) {
          StudentsTable.need_to_be_reloaded();
        }
      });
    };

    StudentsTable.bind = function() {
      console.log("Student: start binding");
      $(this.selector_form_add).ajaxForm({
        success: function(response, status, xhr, $form) {
          console.log('added');
          StudentsTable.last_student_id = -1;
          StudentsTable.last_action = StudentsTable.ACTIONS.Add;
          if (StudentsTable.need_to_be_reloaded !== null) {
            StudentsTable.need_to_be_reloaded();
          }
        }
      });
      $(this.selector_form_remove).ajaxForm({
        success: function(response, status, xhr, $form) {
          console.log("removed");
          StudentsTable.last_student_id = -1;
          StudentsTable.last_action = StudentsTable.ACTIONS.Remove;
          if (StudentsTable.need_to_be_reloaded !== null) {
            StudentsTable.need_to_be_reloaded();
          }
        }
      });
      $(this.selector_form_update).submit(function() {
        console.log('form updated');
        StudentsTable.last_student_id = $(this).find('input[name=student_id]')[0].value || -1;
        StudentsTable.send_changed_students();
        return false;
      });
      $("" + this.selector_form_update + " input[type=text]").on('input', function() {
        var name, old_value;
        name = "" + this.name + StudentsTable.pstfx_old;
        old_value = $(this).siblings("input[name=" + name + "]")[0].value;
        $(this).parents('.form-group').toggleClass("has-success", old_value !== this.value);
        return $(this).siblings('span.glyphicon.form-control-feedback').toggleClass("hidden", old_value === this.value);
      });
      console.log("Student: end binding");
      return this;
    };

    StudentsTable.restore_last_state = function() {
      console.log("Students: restoring");
      if (StudentsTable.last_action === StudentsTable.ACTIONS.Add) {
        $("#add_student_family_input").focus();
      }
      if (StudentsTable.last_action === StudentsTable.ACTIONS.Update) {
        StudentsTable.select_last_student_form_update();
      }
      return this;
    };

    return StudentsTable;

  })();

  GroupNav = (function() {
    function GroupNav() {}

    GroupNav.need_to_be_reloaded = null;

    GroupNav.active_btn_style = 'btn-primary';

    GroupNav.selector_nav = "#groups-nav";

    GroupNav.selector_submit_link = "" + GroupNav.selector_nav + " .submit-link";

    GroupNav.selector_submit_link_forms = "" + GroupNav.selector_submit_link + " form.item";

    GroupNav.selector_form_remove = "" + GroupNav.selector_nav + " form.remove";

    GroupNav.selector_form_update = "" + GroupNav.selector_nav + " form.update";

    GroupNav.selector_form_add = "" + GroupNav.selector_nav + " form.add";

    GroupNav.selector_students_table_content = StudentsTable.selector_table;

    GroupNav.clear_items = function() {
      $(GroupNav.selector_submit_link).toggleClass(GroupNav.active_btn_style, false);
    };

    GroupNav.bind = function() {
      console.log("Group: beind begin");
      $(this.selector_form_remove).ajaxForm({
        success: function(response, status, xhr, $form) {
          console.log('removed');
          if (GroupNav.need_to_be_reloaded) {
            GroupNav.need_to_be_reloaded();
          }
        }
      });
      $(this.selector_form_update).ajaxForm({
        success: function(response, status, xhr, $form) {
          console.log('updated');
          if (GroupNav.need_to_be_reloaded) {
            GroupNav.need_to_be_reloaded();
          }
        }
      });
      $(this.selector_form_add).ajaxForm({
        success: function(response, status, xhr, $form) {
          console.log('added');
          if (GroupNav.need_to_be_reloaded) {
            GroupNav.need_to_be_reloaded();
          }
        }
      });
      $(this.selector_submit_link).click(function() {
        console.log("clicked");
        GroupNav.clear_items();
        $(this).toggleClass(GroupNav.active_btn_style, true);
        $(this).find('form').ajaxSubmit({
          target: GroupNav.selector_students_table_content,
          success: function(response, status, xhr, $form) {
            console.log('Group - submit: @selector_submit_link_forms: success');
            StudentsTable.bind().restore_last_state();
          }
        });
        return false;
      });
      console.log("Group: beind end");
      return this;
    };

    GroupNav.restore_last_state = function() {
      var siblings;
      console.log("Group: restoring");
      if (cookie_group_id()) {
        siblings = $(GroupNav.selector_submit_link_forms).find("input[name='group_id'][value='" + (cookie_group_id()) + "']").siblings('[type=submit]');
        if (siblings.size() > 0) {
          siblings[0].click();
        }
      }
      return this;
    };

    return GroupNav;

  })();

  YearNav = (function() {
    function YearNav() {}

    YearNav.selector_form = "form#year_selector";

    YearNav.selector_select = "" + YearNav.selector_form + " select";

    YearNav.selector_group_nav_content = "#groups-content";

    YearNav.bind = function() {
      console.log("YearNav:bind begin");
      $(this.selector_form).ajaxForm({
        target: this.selector_group_nav_content,
        success: function(response, status, xhr, $form) {
          GroupNav.bind().restore_last_state();
        }
      });
      $(this.selector_select).on('change', function() {
        $(YearNav.selector_form).submit();
      });
      console.log("YearNav:bind end");
      return this;
    };

    YearNav.year = function() {
      return $(this.selector_select).val();
    };

    YearNav.restore_last_state = function() {
      $(YearNav.selector_select).val(cookie_year());
      $(YearNav.selector_form).submit();
      return this;
    };

    return YearNav;

  })();

  StudentsControl = (function() {
    function StudentsControl() {
      StudentsTable.need_to_be_reloaded = GroupNav.restore_last_state;
      GroupNav.need_to_be_reloaded = YearNav.restore_last_state;
      YearNav.bind().restore_last_state();
      this;
    }

    return StudentsControl;

  })();

  window.StudentsControl = StudentsControl;

}).call(this);
